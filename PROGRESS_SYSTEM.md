# 進捗表示システムの仕組み

## 概要

アプリケーションの進捗表示は、**実際の処理ステップ**に基づいており、**滑らかに補間**されて表示されます。

---

## 進捗の流れ

### 0% - 準備中
```
【Workerスレッド】
初期化、進捗管理スレッドの開始
```

### 5% - 初期化
```
【Workerスレッド】
asyncioイベントループの作成
```

### 10% - 画像を準備
```
【GenerateService】
画像データの前処理開始
```

### 15% - API接続確認
```
【GenerateService】
API接続状態の確認
```

### 20% - リクエスト準備
```
【GenerateService】
生成リクエストの構築
```

### 25% - API接続確認
```
【GeminiImagenAdapter】
Gemini APIへの接続確認
```

### 30% - モデル初期化
```
【GeminiImagenAdapter】
Geminiモデルのロード
```

### 35-90% - 画像生成（メイン処理）
```
【GeminiImagenAdapter】
各画像の生成プロセス:

画像1/N:
  35% - 生成準備
  40% - 服の画像を読み込み
  46% - プロンプトを構築
  51% - Gemini APIに送信
  84% - 生成結果を処理

※ 複数枚生成時はこの範囲を均等に分配
```

### 95% - 画像処理
```
【GenerateService】
生成された画像の後処理
```

### 100% - 完了
```
【Workerスレッド】
結果をUIに通知
```

---

## 滑らかな補間の仕組み

### 1. 目標進捗の管理

```python
# 現在の進捗
self.current_progress = 0

# 目標進捗（各ステップで更新）
self.target_progress = 0
```

### 2. 滑らか更新スレッド

```python
def smooth_progress_updater():
    while smooth_update_running:
        if current_progress < target_progress:
            # 1%ずつ増加
            current_progress = min(
                current_progress + 1,
                target_progress
            )
            # UIを更新
            progress_updated.emit(current_progress, message)
        
        time.sleep(0.1)  # 0.1秒ごと
```

### 3. 実際の処理での進捗報告

```python
# 例: 25%に設定
if self.progress_callback:
    self.progress_callback("Geminiモデルを初期化...", 25)

# → target_progress = 25 に設定される
# → smooth_updaterが0%から25%まで滑らかに増加
```

---

## 視覚的な表示

### アプリケーション画面:

```
0秒:  [░░░░░░░░░░] 0%  - 準備中...
0.5秒: [█░░░░░░░░░] 5%  - 初期化しています...
1.0秒: [██░░░░░░░░] 10% - 画像を準備しています...
1.5秒: [███░░░░░░░] 15% - API接続を確認しています...
2.0秒: [████░░░░░░] 20% - 生成リクエストを準備しています...
2.5秒: [█████░░░░░] 25% - API接続を確認しています...
3.0秒: [██████░░░░] 30% - Geminiモデルを初期化しています...
3.5秒: [███████░░░] 35% - 画像 1/1 の生成準備中...
4.0秒: [████████░░] 40% - 服の画像を読み込んでいます...
...
15秒: [█████████░] 90% - 生成結果を処理中...
15.5秒:[██████████] 100% - 生成が完了しました
```

### 特徴:

1. **0.1秒ごとに1%増加**
   - 10%増加するのに約1秒
   - 非常に滑らか

2. **実際の処理に同期**
   - 重い処理の間は進捗が停滞
   - 処理完了後に次の目標へ進む

3. **メッセージの切り替え**
   - 各ステップで適切なメッセージ表示
   - 何が起きているか明確

---

## 複数画像生成時の進捗

### 4枚生成する場合:

```
0-30%:  初期化処理
30-44%: 画像1の生成（35-90の範囲の1/4）
44-58%: 画像2の生成
58-72%: 画像3の生成
72-86%: 画像4の生成
86-95%: 後処理
95-100%: 完了
```

---

## トラブルシューティング

### Q: 進捗が途中で止まる

**原因**: API通信中は進捗更新が停止する（正常）  
**対策**: 最大90%まで進み、そこで待機

### Q: 進捗が飛ぶ（0% → 30%等）

**原因**: 実際のアプリでは滑らかに補間される  
**対策**: コンソールテストでは確認しにくい（アプリで確認）

### Q: 進捗が100%にならない

**原因**: 処理が失敗している  
**対策**: エラーメッセージを確認

---

## コードの場所

- **Workerスレッド**: `app/ui/main_window.py` - GenerationWorker.run()
- **サービス層**: `app/core/pipeline/generate_service.py` - GenerateService
- **アダプター層**: `app/core/adapters/gemini_imagen_adapter.py` - GeminiImagenAdapter

---

**作成日**: 2025年11月11日  
**バージョン**: 2.0.0

