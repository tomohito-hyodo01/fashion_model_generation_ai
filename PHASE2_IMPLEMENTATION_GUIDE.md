# Phase 2 実装完了ガイド

## ✅ 実装完了内容

Phase 2の機能がすべて実装されました！

### 実装された機能

1. **異なる角度からの画像生成（マルチアングル）** ✅
   - 同じ衣類・モデルで異なる角度から撮影
   - 1枚・2枚・3枚・4枚に応じた最適な角度を自動選択
   - seedを固定して一貫性を保持

2. **生成モード選択UI** ✅
   - 種類違い（バリエーション）モード
   - 角度違い（マルチアングル）モード
   - ラジオボタンで簡単切り替え

3. **チャット機能による対話修正** ✅
   - 生成画像に対してテキストで修正指示
   - Gemini APIで自然言語を解析
   - パラメータを自動調整して再生成

4. **会話履歴管理** ✅
   - 対話履歴を保持
   - 文脈を考慮した修正
   - 複数回の修正に対応

---

## 🎨 新しいUI構造

### メインウィンドウ（Phase 2更新後）

```
┌─────────────────────────────────────────────┬────────────────────┐
│  Virtual Fashion Try-On                     │                    │
├─────────────────┬───────────────────────────┤  💬 チャットで修正 │
│ 衣類画像        │  モデル属性               │                    │
│  [+ 画像追加]   │  [基本] [ポーズ] [背景]   │  [会話履歴]        │
│                 │                           │                    │
│  [服1]          │  ギャラリー表示           │  ユーザー: もっと  │
│  [服2]          │                           │  明るくして        │
│                 │                           │                    │
├─────────────────┴───────────────────────────┤  AI: 承知しました  │
│  生成設定                                   │  [修正画像]        │
│  [サイズ] [枚数]                            │                    │
│  生成モード:                                │  [入力欄]          │
│    (●) 種類違い  ( ) 角度違い               │  [送信]            │
│  [生成開始]                                 │                    │
├─────────────────────────────────────────────┴────────────────────┤
│  生成結果ギャラリー                                              │
│  [画像1] [画像2] [画像3] [画像4]                                 │
│  [この画像を修正] [この画像を修正] ...                           │
└──────────────────────────────────────────────────────────────────┘
```

### 生成モード選択

```
生成モード:
  (●) 種類違い（バリエーション）
      → 同じ条件で異なるバリエーションの画像を生成
      
  ( ) 角度違い（マルチアングル）
      → 同じモデル・衣類で異なる角度から撮影した画像を生成
      
💡 角度違いモード: 同じモデル・衣類で異なる角度から撮影した画像を生成します
```

### マルチアングル生成の角度

| 枚数 | 生成される角度 |
|------|---------------|
| 1枚 | 正面（0°） |
| 2枚 | 正面（0°）、背面（180°） |
| 3枚 | 正面（0°）、側面（90°）、背面（180°） |
| 4枚 | 正面（0°）、斜め前（45°）、側面（90°）、斜め後ろ（135°） |

### チャット修正の流れ

```
1. 画像生成
   ↓
2. ギャラリーで画像を選択
   ↓
3. 「この画像を修正」ボタンをクリック
   ↓
4. チャットパネルに画像が表示される
   ↓
5. テキストで修正指示を入力
   例: 「もっと明るくして」
       「背景を青空に変更」
       「笑顔にして」
   ↓
6. Gemini APIが指示を解析
   ↓
7. パラメータを自動調整
   ↓
8. 修正画像を生成
   ↓
9. チャットに結果が表示される
   ↓
10. さらに修正指示を出すことも可能
```

---

## 📦 新規作成ファイル（Phase 2）

| ファイル | 説明 |
|---------|------|
| `app/core/pipeline/multi_angle_generator.py` | 複数角度生成エンジン |
| `app/ui/widgets/chat_refinement.py` | チャット修正ウィジェット |
| `app/core/pipeline/chat_instruction_parser.py` | 自然言語解析（Gemini API） |
| `app/core/pipeline/chat_refinement_service.py` | チャット修正サービス |
| `verification/test_animated_video.py` | アニメーション動画生成テスト |
| `verification/test_image_sequence_video.py` | 画像シーケンス動画テスト |

---

## 🔧 セットアップ手順

### 依存パッケージ（Phase 2用）

すべて既にインストール済みです：

```bash
# 既存のrequirements.txtに含まれています
google-generativeai>=0.8.0  # Gemini API
opencv-python>=4.8.0  # 動画生成用
mediapipe>=0.10.0  # ポーズ抽出用
```

---

## 🎯 使用方法

### 1. マルチアングル生成の使用方法

#### ステップ1: 生成モードを選択
1. 生成設定エリアで「角度違い（マルチアングル）」を選択

#### ステップ2: 枚数を指定
- 1枚: 正面のみ
- 2枚: 正面+背面
- 3枚: 正面+側面+背面
- 4枚: 正面+斜め前+側面+斜め後ろ

#### ステップ3: 生成開始
- 「生成開始」ボタンをクリック
- 選択した枚数分、異なる角度から画像が生成されます

#### 特徴
- ✅ **一貫性**: 同じseedを使用して同じモデルを維持
- ✅ **自動角度選択**: 枚数に応じて最適な角度を自動選択
- ✅ **高品質**: 各角度ごとに最適なプロンプトを生成

---

### 2. チャット修正の使用方法

#### ステップ1: 画像を生成
- 通常通り画像を生成

#### ステップ2: 修正したい画像を選択
- ギャラリーで「この画像を修正」ボタンをクリック
- 右側のチャットパネルに画像が表示される

#### ステップ3: 修正指示を入力
テキスト入力欄に自然な言葉で指示を入力：

**明るさ・照明の例：**
- 「もっと明るくして」
- 「暗めに調整」
- 「夕方の照明で」

**背景の例：**
- 「背景を青空に変更」
- 「ビーチの背景にして」
- 「室内の背景に変更」

**表情の例：**
- 「笑顔にして」
- 「真剣な表情で」
- 「リラックスした雰囲気で」

**ポーズの例：**
- 「腕組みのポーズに変更」
- 「座っているポーズにして」
- 「歩いている感じで」

**組み合わせの例：**
- 「もっと明るくして、笑顔にしてください」
- 「背景を森にして、カジュアルな雰囲気で」

#### ステップ4: AIが解析・再生成
- Gemini APIが指示を解析
- パラメータを自動調整
- 修正画像を生成してチャットに表示

#### ステップ5: さらに修正（オプション）
- 満足するまで何度でも修正指示を出せます
- 会話履歴が保持されるため、文脈を考慮した修正が可能

---

## 📊 技術的な詳細

### マルチアングル生成の仕組み

```python
# 枚数: 4枚の場合
angles = [0, 45, 90, 135]  # 正面、斜め前、側面、斜め後ろ

# 各角度でプロンプトを生成
for angle in angles:
    model_attrs.pose = get_pose_for_angle(angle)
    model_attrs.custom_description = get_description_for_angle(angle)
    
    # 同じseedで生成（一貫性）
    config.seed = fixed_seed
    
    image = generate(garments, model_attrs, config)
    images.append(image)
```

### チャット指示解析の仕組み

```python
# ユーザー指示
instruction = "もっと明るくして、笑顔にしてください"

# Gemini APIで解析
modifications = parser.parse_instruction(instruction, current_params, history)

# 結果例:
{
  "changes": {
    "lighting": "bright, well-lit",
    "expression": "smiling, happy",
    "prompt_additions": "bright lighting, model with a warm smile"
  },
  "ai_response": "承知しました。明るさを上げて、笑顔の表情で画像を再生成します。"
}

# パラメータを更新して再生成
updated_params = apply_modifications(current_params, modifications)
new_image = generate(garments, updated_params, config)
```

### Geminiプロンプト構造

チャット指示解析には以下のプロンプトを使用：

```
【ユーザーの指示】
{instruction}

【現在のパラメータ】
- 性別: female
- 年代: 20s
- ポーズ: front
- 背景: white

【タスク】
JSON形式で変更内容を返す:
{
  "changes": {...},
  "ai_response": "..."
}
```

---

## 🧪 テスト

### マルチアングル生成のテスト

```bash
# MultiAngleGeneratorの動作確認
python app/core/pipeline/multi_angle_generator.py
```

**期待される出力:**
```
1枚生成時の角度:
  - 0度: 正面
  
2枚生成時の角度:
  - 0度: 正面
  - 180度: 背面
  
3枚生成時の角度:
  - 0度: 正面
  - 90度: 側面
  - 180度: 背面
  
4枚生成時の角度:
  - 0度: 正面
  - 45度: 斜め前
  - 90度: 側面
  - 135度: 斜め後ろ
```

### チャット指示解析のテスト

```bash
# ChatInstructionParserの動作確認
python app/core/pipeline/chat_instruction_parser.py
```

**期待される動作:**
- 各テスト指示が正しく解析される
- JSON形式で変更内容が返される
- AI応答が日本語で生成される

---

## 🚀 実際の使用例

### 例1: マルチアングル生成

```
【操作】
1. 衣類画像をアップロード
2. モデル属性を設定
3. 生成設定で:
   - 枚数: 4
   - 生成モード: 角度違い（マルチアングル）
4. 生成開始

【結果】
4枚の画像が生成されます：
- 画像1: 正面から撮影
- 画像2: 斜め前から撮影（45度）
- 画像3: 側面から撮影（90度）
- 画像4: 斜め後ろから撮影（135度）

すべて同じモデル・同じ衣類で、角度だけが異なります。
```

### 例2: チャット修正

```
【操作】
1. 画像を生成（通常通り）
2. ギャラリーで「この画像を修正」をクリック
3. チャットパネルに画像が表示される
4. 修正指示を入力:

   ユーザー: 「もっと明るくして」
   AI: 「承知しました。明るさを調整して再生成します」
   [修正画像が表示される]
   
   ユーザー: 「背景を森にして」
   AI: 「背景を自然の森に変更します」
   [さらに修正された画像が表示される]
   
   ユーザー: 「笑顔にして」
   AI: 「笑顔の表情で再生成します」
   [最終修正画像が表示される]

【結果】
- 対話形式で段階的に修正
- 各修正画像がチャット履歴に保存
- 最終的に理想の画像が完成
```

---

## 💡 実装の工夫

### 1. 一貫性の確保（マルチアングル）

```python
# 同じseedを使用して一貫性を保つ
if base_config.seed is None:
    base_config.seed = random.randint(0, 1000000)

# すべての角度で同じseedを使用
for angle in angles:
    angle_config = copy.deepcopy(base_config)
    angle_config.seed = base_config.seed  # 固定
    generate(garments, angle_attrs, angle_config)
```

### 2. 自然言語理解（チャット修正）

```python
# Gemini 2.0 Flash Expモデルを使用
model = genai.GenerativeModel('gemini-2.0-flash-exp')

# 構造化されたプロンプトで解析
prompt = f"""
ユーザーの指示: {instruction}
現在のパラメータ: {current_params}

JSON形式で返してください:
{{
  "changes": {{...}},
  "ai_response": "..."
}}
"""

response = model.generate_content(prompt)
modifications = parse_json(response.text)
```

### 3. 会話履歴の活用

```python
# 直近5件の会話履歴を考慮
history_text = ""
for msg in conversation_history[-5:]:
    sender = "ユーザー" if msg["sender"] == "user" else "AI"
    history_text += f"{sender}: {msg['message']}\n"

# プロンプトに履歴を含める
prompt = f"""
【会話履歴】
{history_text}

【新しい指示】
{new_instruction}
"""
```

---

## 🎬 動画生成機能について

Phase 2では、Stable Video APIが利用できないことが判明したため、
以下の代替案を実装しました：

### 実装済み代替案

1. **画像シーケンス動画** (`test_image_sequence_video.py`)
   - 複数の画像を連続表示
   - スライドショー形式

2. **アニメーション動画** (`test_animated_video.py`)
   - 1枚の画像から動きを生成
   - Ken Burns効果
   - 3D回転効果
   - 複合エフェクト

### 使用方法

```bash
# アニメーション動画を生成
python verification/test_animated_video.py

# 選択:
# 6. 複合エフェクト（推奨）
```

---

## 📝 変更履歴

### Phase 2 (2025-11-14)

- ✅ MultiAngleGeneratorクラス実装
- ✅ 生成モード選択UI実装
- ✅ ChatRefinementWidgetクラス実装
- ✅ ChatInstructionParserクラス実装（Gemini API）
- ✅ ChatRefinementServiceクラス実装
- ✅ メインウィンドウへの統合
- ✅ GalleryViewに画像選択機能追加
- ✅ 会話履歴管理機能

---

## 🔍 トラブルシューティング

### マルチアングル生成で同じ角度の画像が生成される

**原因**: seedが固定されていない、またはAPIが角度を認識していない

**解決策**:
- プロンプトの角度指示を確認
- Gemini APIが角度指示を理解しているか確認
- 複数回試す（AIの理解度に依存）

### チャット修正が効かない

**原因**: Gemini APIの解析が不正確

**解決策**:
- より明確な指示を出す
- 一度に複数の指示を出さない
- 「明るさ」「背景」など、具体的に指示

### Gemini APIがJSON形式で返さない

**原因**: プロンプトの解釈が曖昧

**解決策**:
- コード内で自動的にフォールバック処理が動作
- エラーが出ても基本的な修正は可能

---

## 🎉 Phase 2の成果

### 実現されたこと

1. **多角的な視点**: 同じ衣類を様々な角度から確認可能
2. **対話的な修正**: 直感的なテキスト指示で画像を修正
3. **効率的なワークフロー**: 何度も最初から生成し直す必要がない
4. **高度なAI活用**: Gemini APIの自然言語理解を活用

### ユーザーメリット

- 🎨 **柔軟性**: 生成後も自由に修正できる
- ⚡ **効率**: 段階的な修正で時間を節約
- 👁️ **多角的**: 複数角度で衣類を確認
- 💬 **直感的**: 専門知識不要で修正指示

---

## 📈 実装進捗

| Phase | 状況 | 完了機能 |
|-------|------|---------|
| Phase 1 | ✅ 完了 | ポーズギャラリー、背景ギャラリー、MediaPipe統合 |
| **Phase 2** | **✅ 完了** | **マルチアングル生成、チャット修正** |
| Phase 3 | ⏳ 未実装 | （将来的な拡張） |

---

## 🚀 今後の拡張案

### Phase 3候補

1. **高度な画像編集**
   - 衣類の色変更
   - アクセサリーの追加/削除
   - 背景の合成（セグメンテーション）

2. **バッチ処理**
   - 複数の衣類を一括処理
   - CSVファイルからの一括生成

3. **履歴管理**
   - 生成履歴の保存
   - お気に入り機能
   - プロジェクト管理

4. **動画生成**
   - Stable Video APIが利用可能になったら統合
   - または高度なアニメーション機能

---

## 📚 ドキュメント

- `PHASE1_IMPLEMENTATION_GUIDE.md` - Phase 1実装ガイド
- `PHASE2_IMPLEMENTATION_GUIDE.md` - このファイル（Phase 2実装ガイド）
- `verification/README.md` - テストプログラムガイド
- `README.md` - プロジェクト概要

---

## 🎊 まとめ

Phase 2の実装により、以下が実現されました：

✨ **多角的な視点**: 同じ衣類を様々な角度から確認  
💬 **対話的な修正**: 自然な言葉で画像を修正  
🎯 **効率的**: 段階的な改善で理想の画像を実現  
🤖 **AI活用**: Geminiの自然言語理解を最大限に活用

これにより、ユーザーは初回生成だけでなく、対話形式で理想の画像に近づけることができるようになりました！


